#!/usr/bin/env bash

if [ "$(id -u)" -ne 0 ]; then
    echo "This script must be run as root" >&2
    exit 1
fi

# Remove the old symlink if it exists and create a new one
rm -f /usr/bin/spinup
ln -s /usr/share/spinup/bin/spinup /usr/bin/spinup

# Create the spinup user if it doesn't exist
if ! id -u spinup &>/dev/null; then
    useradd -r -s /bin/false spinup

    # Add the spinup user to the sudo group
    usermod -aG sudo spinup
fi

# Set the correct permissions on the spinup directory
chown -R spinup:spinup /usr/share/spinup

# Set the correct permissions on the spinup binary
chown root:spinup /usr/share/spinup/bin/spinup

if ! grep -q "^@includedir /etc/sudoers.d[[:space:]]*$" /etc/sudoers; then
    # Make a backup of the sudoers file
    cp /etc/sudoers /etc/sudoers.bak

    # Add the sudoers.d directory to the sudoers file if it has not been included
    echo "@includedir /etc/sudoers.d" | visudo -c -f - &>/dev/null && echo "@includedir /etc/sudoers.d" | EDITOR='tee -a' visudo &>/dev/null
fi
